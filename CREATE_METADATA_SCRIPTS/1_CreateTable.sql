WITH X AS (SELECT cols.table_name, cols.column_name, cols.position FROM user_constraints cons, user_cons_columns cols  WHERE cons.constraint_type = 'P' AND cons.constraint_name = cols.constraint_name AND cons.owner = cols.owner), XT AS ( SELECT cols.table_name, cols.column_name, cols.position, DECODE (cols.position, 1, ' CREATE TABLE ' || cols.table_name || '(', '') || DECODE (cols.position, 1, '', ',') || cols.column_name || ' ' || RTRIM (data_type) || RTRIM ( DECODE ( data_type, 'DATE', NULL, 'LONG', NULL, 'NUMBER', DECODE (TO_CHAR (data_precision), NULL, NULL, '('), '(')) || RTRIM ( DECODE ( data_type, 'DATE', NULL, 'CHAR', data_length, 'VARCHAR2', data_length, 'NUMBER', DECODE ( TO_CHAR (data_precision), NULL, NULL,  TO_CHAR (data_precision) || ',' || TO_CHAR (data_scale)), 'LONG', NULL, '******ERROR')) || RTRIM ( DECODE ( data_type, 'DATE', NULL, 'LONG', NULL, 'NUMBER', DECODE (TO_CHAR (data_precision), NULL, NULL, ')'), ')')) || RTRIM (DECODE (nullable, 'N', ' NOT NULL', NULL)) || DECODE (cols.position, X.LASTposition, ')', '') METADDL, CONS.CONSTRAINT_NAME, CONS.INDEX_NAME FROM user_constraints cons, user_cons_columns cols, USER_tab_columns tc, USER_objects o, ( SELECT table_name,  MAX (position) LASTposition,  MIN (position) FIRSTposition FROM X GROUP BY table_name) X  WHERE cols.table_name LIKE UPPER ('&&tableprefix') || '%' AND cons.constraint_type = 'P' AND cons.constraint_name = cols.constraint_name AND cons.owner = cols.owner AND o.object_name = cols.table_name AND o.object_name = tc.table_name AND COLS.COLUMN_NAME = TC.COLUMN_NAME AND X.table_name = tc.table_name ORDER BY cols.table_name, cols.position)  SELECT 'DECLARE BEGIN IF (CHK_TBL(''' || TABLE_NAME || ''') <= 0) THEN EXECUTE IMMEDIATE ''' || LISTAGG (METADDL, ' ')  WITHIN GROUP (ORDER BY TABLE_NAME, position, CONSTRAINT_NAME, INDEX_NAME) || '''; END IF; ' || ' IF (CHK_IX(''' || INDEX_NAME || ''') <= 0) THEN EXECUTE IMMEDIATE ''CREATE UNIQUE INDEX ' || INDEX_NAME || ' ON ' || TABLE_NAME || '(' || LISTAGG (column_name, ', ')  WITHIN GROUP (ORDER BY TABLE_NAME, position, CONSTRAINT_NAME, INDEX_NAME) || ')''; END IF; ' || ' IF (CHK_CNSTR(''' || CONSTRAINT_NAME || ''') <= 0) THEN EXECUTE IMMEDIATE ''ALTER TABLE ' || TABLE_NAME || ' ADD (CONSTRAINT ' || CONSTRAINT_NAME || ' PRIMARY KEY (' || LISTAGG (column_name, ', ')  WITHIN GROUP (ORDER BY TABLE_NAME, position, CONSTRAINT_NAME, INDEX_NAME) || ') USING INDEX ' || INDEX_NAME || ' ENABLE VALIDATE) ''; END IF;' || ' END; ' || '~~'  AS CREATESCRIPT FROM XT GROUP BY TABLE_NAME, CONSTRAINT_NAME, INDEX_NAME ORDER BY TABLE_NAME